<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Tradutor Profissional">
    
    <title>Tradutor Profissional - 75+ Idiomas</title>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-user-select: none; user-select: none; }
        html, body { width: 100%; height: 100%; overflow: hidden; }
        body { font-family: -apple-system, system-ui, sans-serif; background: #0f172a; color: #f0f4f8; display: flex; flex-direction: column; }
        .container { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
        .header { background: #1a2a4a; padding: 1.5rem 1rem; text-align: center; border-bottom: 1px solid #3b82f6; }
        .header h1 { font-size: 1.5rem; color: #60a5fa; }
        .status-bar { display: flex; gap: 0.5rem; justify-content: center; align-items: center; margin-top: 0.5rem; }
        .status-indicator { display: flex; align-items: center; gap: 0.5rem; padding: 0.3rem 0.7rem; border-radius: 20px; font-size: 0.7rem; font-weight: 600; border: 1px solid #3b82f6; }
        .status-indicator.online { color: #86efac; border-color: #22c55e; }
        .status-indicator.offline { color: #fca5a5; border-color: #ef4444; }
        .voice-selector-btn { padding: 0.4rem 0.8rem; background: #3b82f6; color: white; border: none; border-radius: 20px; cursor: pointer; font-size: 0.8rem; }
        .content { flex: 1; padding: 1rem; display: flex; flex-direction: column; gap: 1rem; }
        .card { background: rgba(30, 41, 59, 0.7); border: 1px solid rgba(96, 165, 250, 0.2); border-radius: 1rem; padding: 1rem; }
        .language-btn { width: 100%; padding: 0.7rem; background: #1e293b; border: 1px solid #3b82f6; border-radius: 0.5rem; color: white; display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; cursor: pointer; }
        textarea { width: 100%; background: transparent; border: none; color: white; font-size: 1.1rem; resize: none; min-height: 80px; outline: none; -webkit-user-select: text; user-select: text; }
        .output-text { min-height: 80px; font-size: 1.1rem; color: #60a5fa; font-weight: 600; word-wrap: break-word; }
        .btn-row { display: flex; gap: 0.5rem; margin-top: 0.5rem; }
        .btn-main { flex: 2; background: #3b82f6; color: white; border: none; border-radius: 0.5rem; padding: 0.7rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .btn-main.listening { background: #ef4444; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
        .btn-secondary { flex: 1; background: #334155; color: white; border: none; border-radius: 0.5rem; padding: 0.7rem; cursor: pointer; font-size: 1.2rem; }
        .dropdown { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: none; z-index: 100; align-items: flex-end; }
        .dropdown.open { display: flex; }
        .dropdown-content { background: #0f172a; border-radius: 1rem 1rem 0 0; width: 100%; max-height: 70vh; overflow-y: auto; border-top: 2px solid #3b82f6; }
        .dropdown-group-title { padding: 0.8rem; background: #1e293b; color: #60a5fa; font-weight: bold; font-size: 0.7rem; text-transform: uppercase; position: sticky; top: 0; z-index: 10; }
        .dropdown-item { padding: 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.7rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background: #1e293b; padding: 1.5rem; border-radius: 1rem; text-align: center; width: 85%; max-width: 400px; }
        .offline-notice { font-size: 0.7rem; color: #94a3b8; text-align: center; margin-top: 0.3rem; }
        .mic-active-text { font-size: 0.8rem; color: #ef4444; margin-top: 0.5rem; display: none; text-align: center; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Tradutor Profissional</h1>
            <div class="status-bar">
                <div id="statusIndicator" class="status-indicator online"><span id="statusText">Online</span></div>
                <button class="voice-selector-btn" onclick="showVoiceSelector()"><span id="voiceIcon">üë©‚Äçüé§</span> Voz</button>
            </div>
        </div>

        <div class="content">
            <div class="card">
                <button class="language-btn" onclick="toggleLanguageDropdown('source')">
                    <span id="sourceFlag">üáßüá∑</span> <span id="sourceName">Portugu√™s (Brasil)</span> <span>‚ñº</span>
                </button>
                <textarea id="inputText" placeholder="Digite ou fale aqui..." oninput="translateText()"></textarea>
                <div id="micActiveText" class="mic-active-text">Ouvindo... Fale agora</div>
                <div class="btn-row">
                    <button id="micBtn" class="btn-main" onclick="toggleMicrophone()">üé§ FALAR</button>
                    <button class="btn-secondary" onclick="clearInput()">‚úï</button>
                </div>
            </div>

            <div class="card">
                <button class="language-btn" onclick="toggleLanguageDropdown('target')">
                    <span id="targetFlag">üá∫üá∏</span> <span id="targetName">English (USA)</span> <span>‚ñº</span>
                </button>
                <div id="outputText" class="output-text">Tradu√ß√£o aparecer√° aqui...</div>
                <div class="btn-row">
                    <button id="speakBtn" class="btn-main" onclick="speakTranslation()">üîä OUVIR</button>
                    <button class="btn-secondary" onclick="copyTranslation()">üìã</button>
                    <button class="btn-secondary" onclick="swapLanguages()">‚áÑ</button>
                </div>
                <div class="offline-notice">Tradu√ß√µes repetidas e voz funcionam offline!</div>
            </div>
        </div>
    </div>

    <div id="sourceDropdown" class="dropdown" onclick="toggleLanguageDropdown('source')">
        <div class="dropdown-content" id="sourceDropdownContent" onclick="event.stopPropagation()"></div>
    </div>
    <div id="targetDropdown" class="dropdown" onclick="toggleLanguageDropdown('target')">
        <div class="dropdown-content" id="targetDropdownContent" onclick="event.stopPropagation()"></div>
    </div>
    <div id="voiceModal" class="modal">
        <div class="modal-content">
            <h3 style="color:#60a5fa; margin-bottom:1.5rem;">Escolha sua Voz</h3>
            <button onclick="selectVoice('male')" class="btn-main" style="width:100%; margin-bottom:0.8rem;">üë®‚Äçüé§ Voz Grave</button>
            <button onclick="selectVoice('female')" class="btn-main" style="width:100%;">üë©‚Äçüé§ Voz Aguda</button>
        </div>
    </div>

    <script>
        const LANGUAGES = {
            'Am√©ricas': [
                { code: 'pt-BR', name: 'Portugu√™s (Brasil)', flag: 'üáßüá∑' },
                { code: 'en-US', name: 'English (USA)', flag: 'üá∫üá∏' },
                { code: 'es-ES', name: 'Espa√±ol (Espa√±a)', flag: 'üá™üá∏' },
                { code: 'es-MX', name: 'Espa√±ol (M√©xico)', flag: 'üá≤üáΩ' },
                { code: 'fr-CA', name: 'Fran√ßais (Canada)', flag: 'üá®üá¶' }
            ],
            'Europa': [
                { code: 'pt-PT', name: 'Portugu√™s (Portugal)', flag: 'üáµüáπ' },
                { code: 'en-GB', name: 'English (UK)', flag: 'üá¨üáß' },
                { code: 'fr-FR', name: 'Fran√ßais (France)', flag: 'üá´üá∑' },
                { code: 'de-DE', name: 'Deutsch (Deutschland)', flag: 'üá©üá™' },
                { code: 'it-IT', name: 'Italiano (Italia)', flag: 'üáÆüáπ' },
                { code: 'ru-RU', name: '–†—É—Å—Å–∫–∏–π (Rossiya)', flag: 'üá∑üá∫' },
                { code: 'nl-NL', name: 'Nederlands (Nederland)', flag: 'üá≥üá±' },
                { code: 'pl-PL', name: 'Polski (Polska)', flag: 'üáµüá±' },
                { code: 'sv-SE', name: 'Svenska (Sverige)', flag: 'üá∏üá™' },
                { code: 'no-NO', name: 'Norsk (Norge)', flag: 'üá≥üá¥' },
                { code: 'da-DK', name: 'Dansk (Danmark)', flag: 'üá©üá∞' },
                { code: 'fi-FI', name: 'Suomi (Suomi)', flag: 'üá´üáÆ' },
                { code: 'el-GR', name: 'ŒïŒªŒªŒ∑ŒΩŒπŒ∫Œ¨ (Ell√°da)', flag: 'üá¨üá∑' },
                { code: 'tr-TR', name: 'T√ºrk√ße (T√ºrkiye)', flag: 'üáπüá∑' }
            ],
            '√Åsia/Oceania': [
                { code: 'zh-CN', name: 'ÁÆÄ‰Ωì‰∏≠Êñá (‰∏≠ÂõΩ)', flag: 'üá®üá≥' },
                { code: 'ja-JP', name: 'Êó•Êú¨Ë™û (Êó•Êú¨)', flag: 'üáØüáµ' },
                { code: 'ko-KR', name: 'ÌïúÍµ≠Ïñ¥ (Daehanminguk)', flag: 'üá∞üá∑' },
                { code: 'hi-IN', name: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä (BhƒÅrat)', flag: 'üáÆüá≥' },
                { code: 'th-TH', name: '‡πÑ‡∏ó‡∏¢ (Prathet Thai)', flag: 'üáπüá≠' },
                { code: 'vi-VN', name: 'Ti·∫øng Vi·ªát (Vi·ªát Nam)', flag: 'üáªüá≥' },
                { code: 'id-ID', name: 'Bahasa Indonesia', flag: 'üáÆüá©' },
                { code: 'ms-MY', name: 'Bahasa Melayu', flag: 'üá≤üáæ' },
                { code: 'bn-BD', name: '‡¶¨‡¶æ‡¶Ç‡¶≤‡¶æ (Bangladesh)', flag: 'üáßüá©' },
                { code: 'he-IL', name: '◊¢◊ë◊®◊ô◊™ (Yisra\'el)', flag: 'üáÆüá±' },
                { code: 'ar-SA', name: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (As-Sa\'≈´diyyah)', flag: 'üá∏üá¶' }
            ],
            '√Åfrica': [
                { code: 'sw-KE', name: 'Kiswahili (Kenya)', flag: 'üá∞üá™' },
                { code: 'af-ZA', name: 'Afrikaans (Suid-Afrika)', flag: 'üáøüá¶' },
                { code: 'yo-NG', name: 'Yor√πb√° (N√†√¨j√≠r√≠√†)', flag: 'üá≥üá¨' },
                { code: 'zu-ZA', name: 'isiZulu (Ningizimu Afrika)', flag: 'üáøüá¶' },
                { code: 'am-ET', name: '·ä†·àõ·à≠·äõ (ƒ™ty≈ç·πó·πóyƒÅ)', flag: 'üá™üáπ' }
            ]
        };

        let sourceLanguage = 'pt-BR';
        let targetLanguage = 'en-US';
        let voiceGender = 'female';
        let translationCache = JSON.parse(localStorage.getItem('translationCache') || '{}');
        let recognition = null;
        let isListening = false;

        function init() {
            updateLanguageDropdowns();
            updateStatusIndicator();
            window.addEventListener('online', updateStatusIndicator);
            window.addEventListener('offline', updateStatusIndicator);
            
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js').catch(()=>{});
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = true; // Mant√©m ouvindo
                recognition.interimResults = true; // Transcreve enquanto fala (r√°pido)
                
                recognition.onstart = () => {
                    isListening = true;
                    document.getElementById('micBtn').classList.add('listening');
                    document.getElementById('micBtn').textContent = 'üõë PARAR';
                    document.getElementById('micActiveText').style.display = 'block';
                };
                
                recognition.onresult = (event) => {
                    let finalTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript;
                        } else {
                            // Resultados parciais para rapidez visual
                            document.getElementById('inputText').value = event.results[i][0].transcript;
                        }
                    }
                    if (finalTranscript) {
                        document.getElementById('inputText').value = finalTranscript;
                        translateText();
                    }
                };
                
                recognition.onerror = (event) => {
                    console.error('Erro reconhecimento:', event.error);
                    stopListening();
                };
                
                recognition.onend = () => {
                    if (isListening) recognition.start(); // Auto-restart se cair
                };
            }
        }

        function toggleMicrophone() {
            if (!recognition) return alert('Seu navegador n√£o suporta reconhecimento de voz.');
            if (isListening) {
                isListening = false;
                recognition.stop();
                stopListening();
            } else {
                recognition.lang = sourceLanguage;
                recognition.start();
            }
        }

        function stopListening() {
            document.getElementById('micBtn').classList.remove('listening');
            document.getElementById('micBtn').textContent = 'üé§ FALAR';
            document.getElementById('micActiveText').style.display = 'none';
        }

        function updateLanguageDropdowns() {
            ['source', 'target'].forEach(type => {
                const content = document.getElementById(type + 'DropdownContent');
                content.innerHTML = '';
                Object.entries(LANGUAGES).forEach(([region, langs]) => {
                    const title = document.createElement('div');
                    title.className = 'dropdown-group-title';
                    title.textContent = region;
                    content.appendChild(title);
                    langs.forEach(lang => {
                        const item = document.createElement('div');
                        item.className = 'dropdown-item';
                        item.innerHTML = `<span>${lang.flag}</span> <span>${lang.name}</span>`;
                        item.onclick = () => selectLanguage(type, lang);
                        content.appendChild(item);
                    });
                });
            });
        }

        function toggleLanguageDropdown(type) { document.getElementById(type + 'Dropdown').classList.toggle('open'); }

        function selectLanguage(type, lang) {
            if (type === 'source') {
                sourceLanguage = lang.code;
                document.getElementById('sourceFlag').textContent = lang.flag;
                document.getElementById('sourceName').textContent = lang.name;
                if (isListening) { // Atualiza idioma do mic em tempo real
                    recognition.stop();
                    setTimeout(() => recognition.start(), 100);
                }
            } else {
                targetLanguage = lang.code;
                document.getElementById('targetFlag').textContent = lang.flag;
                document.getElementById('targetName').textContent = lang.name;
            }
            toggleLanguageDropdown(type);
            translateText();
        }

        function translateText() {
            const text = document.getElementById('inputText').value.trim();
            const out = document.getElementById('outputText');
            if (!text) { out.textContent = 'Tradu√ß√£o aparecer√° aqui...'; return; }
            
            const key = `${sourceLanguage}|${targetLanguage}|${text.toLowerCase()}`;
            if (translationCache[key]) { out.textContent = translationCache[key]; return; }
            
            if (!navigator.onLine) { out.textContent = '[Offline: Tradu√ß√£o n√£o salva]'; return; }
            
            fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${sourceLanguage}|${targetLanguage}`)
                .then(r => r.json()).then(data => {
                    const res = data.responseData.translatedText;
                    out.textContent = res;
                    translationCache[key] = res;
                    localStorage.setItem('translationCache', JSON.stringify(translationCache));
                }).catch(() => out.textContent = 'Erro ao traduzir');
        }

        function speakTranslation() {
            const text = document.getElementById('outputText').textContent;
            if (!text || text.includes('Tradu√ß√£o')) return;
            const synth = window.speechSynthesis;
            synth.cancel();
            const utt = new SpeechSynthesisUtterance(text);
            utt.lang = targetLanguage;
            
            const voices = synth.getVoices();
            let v = voices.find(v => v.lang.startsWith(targetLanguage.split('-')[0]) && (voiceGender === 'male' ? !v.name.includes('female') : v.name.includes('female')));
            if (!v) v = voices.find(v => v.lang.startsWith(targetLanguage.split('-')[0]));
            if (v) utt.voice = v;
            
            synth.speak(utt);
        }

        function selectVoice(g) { voiceGender = g; document.getElementById('voiceIcon').textContent = g === 'male' ? 'üë®‚Äçüé§' : 'üë©‚Äçüé§'; document.getElementById('voiceModal').style.display = 'none'; localStorage.setItem('voiceGender', g); }
        function showVoiceSelector() { document.getElementById('voiceModal').style.display = 'flex'; }
        function clearInput() { document.getElementById('inputText').value = ''; translateText(); }
        function copyTranslation() { navigator.clipboard.writeText(document.getElementById('outputText').textContent); alert('Copiado!'); }
        function swapLanguages() { [sourceLanguage, targetLanguage] = [targetLanguage, sourceLanguage]; translateText(); updateLanguageDropdowns(); }
        
        function updateStatusIndicator() {
            const ind = document.getElementById('statusIndicator');
            const txt = document.getElementById('statusText');
            if (navigator.onLine) { ind.className = 'status-indicator online'; txt.textContent = 'Online'; }
            else { ind.className = 'status-indicator offline'; txt.textContent = 'Offline'; }
        }

        window.addEventListener('load', () => { 
            const savedGender = localStorage.getItem('voiceGender');
            if (savedGender) selectVoice(savedGender);
        });
        
        init();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, user-scalable=no">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Tradutor Profissional - Voz & CÃ¢mera</title>

    <!-- Bibliotecas Externas -->
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --bg-dark: #0f172a;
            --card-bg: #1e293b;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --accent: #60a5fa;
            --danger: #ef4444;
            --success: #22c55e;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-main);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* Header */
        .app-header {
            background: var(--card-bg);
            padding: 1rem;
            text-align: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .app-header h1 { font-size: 1.25rem; color: var(--accent); font-weight: 700; }
        .online-badge { font-size: 0.7rem; background: rgba(34, 197, 94, 0.2); color: var(--success); padding: 2px 8px; border-radius: 10px; margin-top: 4px; display: inline-block; }

        /* Tabs Navigation */
        .nav-tabs {
            display: flex;
            background: var(--card-bg);
            padding: 0.5rem;
            gap: 0.5rem;
        }
        .tab-btn {
            flex: 1;
            border: none;
            background: transparent;
            color: var(--text-muted);
            padding: 0.75rem 0.5rem;
            border-radius: 0.75rem;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }
        .tab-btn i { font-size: 1.1rem; }
        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        .tab-panel { display: none; flex-direction: column; gap: 1rem; height: 100%; }
        .tab-panel.active { display: flex; }

        /* Cards */
        .card {
            background: var(--card-bg);
            border-radius: 1.25rem;
            padding: 1.25rem;
            border: 1px solid rgba(255,255,255,0.05);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        /* Language Selectors */
        .lang-selector {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(15, 23, 42, 0.5);
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            margin-bottom: 1rem;
            cursor: pointer;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        .lang-info { display: flex; align-items: center; gap: 10px; }
        .lang-flag { font-size: 1.2rem; }
        .lang-name { font-weight: 600; font-size: 0.9rem; }

        /* Text Areas */
        textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: white;
            font-size: 1.1rem;
            resize: none;
            min-height: 100px;
            outline: none;
            line-height: 1.5;
        }
        .output-area {
            min-height: 100px;
            font-size: 1.1rem;
            color: var(--accent);
            font-weight: 600;
            line-height: 1.5;
            word-break: break-word;
        }

        /* Buttons */
        .btn-group { display: flex; gap: 0.75rem; margin-top: 1rem; }
        .btn {
            border: none;
            border-radius: 0.75rem;
            padding: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: transform 0.1s;
        }
        .btn:active { transform: scale(0.97); }
        .btn-primary { background: var(--primary); color: white; flex: 2; }
        .btn-secondary { background: #334155; color: white; flex: 1; }
        .btn-danger { background: var(--danger); color: white; }
        
        .btn-mic.active {
            background: var(--danger);
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }

        /* Camera View */
        .camera-box {
            position: relative;
            width: 100%;
            aspect-ratio: 4/3;
            background: #000;
            border-radius: 1rem;
            overflow: hidden;
            border: 2px solid var(--primary);
        }
        #videoFeed { width: 100%; height: 100%; object-fit: cover; }
        .camera-guide {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80%; height: 60%;
            border: 2px dashed rgba(255,255,255,0.5);
            border-radius: 10px;
            pointer-events: none;
        }
        .ocr-overlay {
            position: absolute;
            inset: 0;
            background: rgba(15, 23, 42, 0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 1000;
            padding: 1rem;
        }
        .modal-content {
            background: var(--card-bg);
            height: 100%;
            border-radius: 1.5rem;
            display: flex;
            flex-direction: column;
        }
        .modal-header {
            padding: 1.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .lang-list { flex: 1; overflow-y: auto; padding: 0.5rem; }
        .lang-item {
            padding: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            border-radius: 0.75rem;
            cursor: pointer;
        }
        .lang-item:active { background: var(--primary); }

        /* Loading Spinner */
        .spinner {
            width: 40px; height: 40px;
            border: 4px solid rgba(59, 130, 246, 0.1);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Toast */
        #toast {
            position: fixed;
            bottom: 2rem; left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            padding: 0.75rem 1.5rem;
            border-radius: 2rem;
            font-weight: 600;
            display: none;
            z-index: 2000;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body>

    <header class="app-header">
        <h1>TRADUTOR PRO</h1>
        <span class="online-badge"><i class="fas fa-circle"></i> SISTEMA ONLINE</span>
    </header>

    <nav class="nav-tabs">
        <button class="tab-btn active" onclick="switchTab('voice')">
            <i class="fas fa-microphone"></i><span>Voz</span>
        </button>
        <button class="tab-btn" onclick="switchTab('camera')">
            <i class="fas fa-camera"></i><span>CÃ¢mera</span>
        </button>
        <button class="tab-btn" onclick="switchTab('gallery')">
            <i class="fas fa-image"></i><span>Galeria</span>
        </button>
    </nav>

    <main class="main-content">
        
        <!-- Aba Voz / Texto -->
        <div id="voicePanel" class="tab-panel active">
            <div class="card">
                <div class="lang-selector" onclick="openModal('source')">
                    <div class="lang-info">
                        <span id="srcFlag" class="lang-flag">ðŸ‡§ðŸ‡·</span>
                        <span id="srcName" class="lang-name">PortuguÃªs (Brasil)</span>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <textarea id="inputText" placeholder="Toque para digitar ou use o microfone..." oninput="autoTranslate()"></textarea>
                <div class="btn-group">
                    <button id="micBtn" class="btn btn-primary btn-mic" onclick="toggleMic()">
                        <i class="fas fa-microphone"></i> FALAR AGORA
                    </button>
                    <button class="btn btn-secondary" onclick="clearAll()">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>

            <div class="card">
                <div class="lang-selector" onclick="openModal('target')">
                    <div class="lang-info">
                        <span id="tgtFlag" class="lang-flag">ðŸ‡ºðŸ‡¸</span>
                        <span id="tgtName" class="lang-name">English (USA)</span>
                    </div>
                    <i class="fas fa-chevron-down"></i>
                </div>
                <div id="outputText" class="output-area">A traduÃ§Ã£o aparecerÃ¡ aqui...</div>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="playAudio()">
                        <i class="fas fa-volume-up"></i> OUVIR
                    </button>
                    <button class="btn btn-secondary" onclick="copyText()">
                        <i class="fas fa-copy"></i>
                    </button>
                    <button class="btn btn-secondary" onclick="swapLangs()">
                        <i class="fas fa-exchange-alt"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- Aba CÃ¢mera -->
        <div id="cameraPanel" class="tab-panel">
            <div class="camera-box">
                <video id="videoFeed" autoplay playsinline></video>
                <div class="camera-guide"></div>
                <div id="ocrOverlay" class="ocr-overlay">
                    <div class="spinner"></div>
                    <p id="ocrStatus" style="margin-top: 1rem; font-weight: 600;">Processando...</p>
                </div>
            </div>
            <button class="btn btn-primary" style="width: 100%; padding: 1.2rem;" onclick="processCamera()">
                <i class="fas fa-magic"></i> TRADUZIR TEXTO DA CÃ‚MERA
            </button>
            <div class="card" style="margin-top: 1rem;">
                <p style="font-size: 0.7rem; color: var(--text-muted); margin-bottom: 0.5rem;">RESULTADO DA LEITURA:</p>
                <div id="cameraResult" class="output-area" style="min-height: 60px; font-size: 1rem;">Aponte para um texto e clique no botÃ£o acima.</div>
            </div>
        </div>

        <!-- Aba Galeria -->
        <div id="galleryPanel" class="tab-panel">
            <div class="card" style="text-align: center; padding: 3rem 1rem;">
                <input type="file" id="filePicker" accept="image/*" style="display: none;" onchange="processGallery(event)">
                <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--primary); margin-bottom: 1rem;"></i>
                <h2 style="margin-bottom: 0.5rem;">Traduzir Foto</h2>
                <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Escolha uma imagem da sua galeria para extrair e traduzir o texto.</p>
                <button class="btn btn-primary" style="width: 100%;" onclick="document.getElementById('filePicker').click()">
                    <i class="fas fa-search"></i> SELECIONAR IMAGEM
                </button>
            </div>
            <div id="galleryResultCard" class="card" style="display: none; margin-top: 1rem;">
                <div id="galleryResult" class="output-area"></div>
            </div>
        </div>

    </main>

    <!-- Modal de Idiomas -->
    <div id="langModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Selecionar Idioma</h3>
                <button class="btn btn-secondary" style="padding: 0.5rem 0.8rem;" onclick="closeModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="langList" class="lang-list"></div>
        </div>
    </div>

    <div id="toast">Copiado com sucesso!</div>

    <script>
        // ConfiguraÃ§Ãµes
        const LANGUAGES = [
            { code: 'pt-BR', name: 'PortuguÃªs (Brasil)', flag: 'ðŸ‡§ðŸ‡·' },
            { code: 'en-US', name: 'English (USA)', flag: 'ðŸ‡ºðŸ‡¸' },
            { code: 'es-ES', name: 'EspaÃ±ol (EspaÃ±a)', flag: 'ðŸ‡ªðŸ‡¸' },
            { code: 'fr-FR', name: 'FranÃ§ais (France)', flag: 'ðŸ‡«ðŸ‡·' },
            { code: 'it-IT', name: 'Italiano (Italia)', flag: 'ðŸ‡®ðŸ‡¹' },
            { code: 'de-DE', name: 'Deutsch (Deutschland)', flag: 'ðŸ‡©ðŸ‡ª' },
            { code: 'ja-JP', name: 'æ—¥æœ¬èªž (æ—¥æœ¬)', flag: 'ðŸ‡¯ðŸ‡µ' },
            { code: 'zh-CN', name: 'ç®€ä½“ä¸­æ–‡ (ä¸­å›½)', flag: 'ðŸ‡¨ðŸ‡³' }
        ];

        let state = {
            src: 'pt-BR',
            tgt: 'en-US',
            activeModal: null,
            isListening: false,
            worker: null,
            stream: null
        };

        // InicializaÃ§Ã£o
        window.onload = () => {
            renderLangs();
            initOCR();
        };

        async function initOCR() {
            try {
                state.worker = await Tesseract.createWorker();
                await state.worker.loadLanguage('por+eng+spa+fra');
                await state.worker.initialize('por+eng+spa+fra');
            } catch (e) { console.error("Erro OCR:", e); }
        }

        function renderLangs() {
            const list = document.getElementById('langList');
            list.innerHTML = LANGUAGES.map(l => `
                <div class="lang-item" onclick="selectLang('${l.code}')">
                    <span>${l.flag}</span>
                    <span>${l.name}</span>
                </div>
            `).join('');
        }

        // NavegaÃ§Ã£o
        function switchTab(tab) {
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(p => p.classList.remove('active'));
            
            document.querySelector(`[onclick="switchTab('${tab}')"]`).classList.add('active');
            document.getElementById(tab + 'Panel').classList.add('active');

            if (tab === 'camera') startCamera(); else stopCamera();
        }

        // Modal
        function openModal(type) {
            state.activeModal = type;
            document.getElementById('langModal').style.display = 'block';
        }
        function closeModal() { document.getElementById('langModal').style.display = 'none'; }
        function selectLang(code) {
            const lang = LANGUAGES.find(l => l.code === code);
            if (state.activeModal === 'source') {
                state.src = code;
                document.getElementById('srcFlag').innerText = lang.flag;
                document.getElementById('srcName').innerText = lang.name;
            } else {
                state.tgt = code;
                document.getElementById('tgtFlag').innerText = lang.flag;
                document.getElementById('tgtName').innerText = lang.name;
            }
            closeModal();
            autoTranslate();
        }

        // TraduÃ§Ã£o Robusta
        let transTimer;
        function autoTranslate() {
            clearTimeout(transTimer);
            const text = document.getElementById('inputText').value.trim();
            if (!text) {
                document.getElementById('outputText').innerText = "A traduÃ§Ã£o aparecerÃ¡ aqui...";
                return;
            }
            transTimer = setTimeout(() => callTranslateAPI(text), 600);
        }

        async function callTranslateAPI(text) {
            const out = document.getElementById('outputText');
            out.innerText = "Traduzindo...";
            
            try {
                // Tentativa 1: MyMemory
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${state.src}|${state.tgt}`);
                const data = await res.json();
                if (data.responseData.translatedText) {
                    out.innerText = data.responseData.translatedText;
                    return;
                }
                throw new Error();
            } catch (e) {
                // Tentativa 2: Google Translate Proxy
                try {
                    const res = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=${state.src.split('-')[0]}&tl=${state.tgt.split('-')[0]}&dt=t&q=${encodeURIComponent(text)}`);
                    const data = await res.json();
                    out.innerText = data[0][0][0];
                } catch (e2) {
                    out.innerText = "Erro na traduÃ§Ã£o. Verifique sua conexÃ£o.";
                }
            }
        }

        // Voz
        let recognition;
        function toggleMic() {
            if (!('webkitSpeechRecognition' in window)) {
                alert("Seu navegador nÃ£o suporta reconhecimento de voz.");
                return;
            }

            if (state.isListening) {
                recognition.stop();
                return;
            }

            recognition = new webkitSpeechRecognition();
            recognition.lang = state.src;
            recognition.onstart = () => {
                state.isListening = true;
                document.getElementById('micBtn').classList.add('active');
                document.getElementById('micBtn').innerHTML = '<i class="fas fa-stop"></i> PARAR AGORA';
            };
            recognition.onend = () => {
                state.isListening = false;
                document.getElementById('micBtn').classList.remove('active');
                document.getElementById('micBtn').innerHTML = '<i class="fas fa-microphone"></i> FALAR AGORA';
            };
            recognition.onresult = (e) => {
                document.getElementById('inputText').value = e.results[0][0].transcript;
                autoTranslate();
            };
            recognition.start();
        }

        function playAudio() {
            const text = document.getElementById('outputText').innerText;
            if (text.includes("...")) return;
            const msg = new SpeechSynthesisUtterance(text);
            msg.lang = state.tgt;
            window.speechSynthesis.speak(msg);
        }

        // CÃ¢mera
        async function startCamera() {
            try {
                state.stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment', width: 1280, height: 720 } 
                });
                document.getElementById('videoFeed').srcObject = state.stream;
            } catch (e) { alert("Erro ao abrir cÃ¢mera."); }
        }
        function stopCamera() {
            if (state.stream) state.stream.getTracks().forEach(t => t.stop());
        }

        async function processCamera() {
            const video = document.getElementById('videoFeed');
            const overlay = document.getElementById('ocrOverlay');
            const result = document.getElementById('cameraResult');
            
            overlay.style.display = 'flex';
            result.innerText = "Lendo imagem...";

            const canvas = document.createElement('canvas');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            const ctx = canvas.getContext('2d');
            ctx.filter = 'contrast(1.4) grayscale(1)';
            ctx.drawImage(video, 0, 0);

            try {
                if (!state.worker) await initOCR();
                const { data: { text } } = await state.worker.recognize(canvas);
                if (text.trim()) {
                    result.innerText = "Traduzindo...";
                    const translated = await translateDirect(text, 'auto', 'pt-BR');
                    result.innerHTML = `<small style="color:var(--text-muted)">Lido: ${text.substring(0,50)}...</small><br>${translated}`;
                } else {
                    result.innerText = "Nenhum texto encontrado.";
                }
            } catch (e) { result.innerText = "Erro no processamento."; }
            overlay.style.display = 'none';
        }

        // Galeria
        async function processGallery(e) {
            const file = e.target.files[0];
            if (!file) return;

            const resultCard = document.getElementById('galleryResultCard');
            const result = document.getElementById('galleryResult');
            
            resultCard.style.display = 'block';
            result.innerText = "Processando imagem...";

            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    if (!state.worker) await initOCR();
                    const { data: { text } } = await state.worker.recognize(event.target.result);
                    if (text.trim()) {
                        const translated = await translateDirect(text, 'auto', 'pt-BR');
                        result.innerHTML = `<strong>TraduÃ§Ã£o:</strong><br>${translated}`;
                    } else {
                        result.innerText = "NÃ£o foi possÃ­vel ler o texto desta imagem.";
                    }
                } catch (err) { result.innerText = "Erro ao ler imagem."; }
            };
            reader.readAsDataURL(file);
        }

        async function translateDirect(text, from, to) {
            try {
                const res = await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${from}|${to}`);
                const data = await res.json();
                return data.responseData.translatedText || "Erro na traduÃ§Ã£o.";
            } catch (e) { return "Erro de conexÃ£o."; }
        }

        // UtilitÃ¡rios
        function clearAll() {
            document.getElementById('inputText').value = "";
            document.getElementById('outputText').innerText = "A traduÃ§Ã£o aparecerÃ¡ aqui...";
        }
        function copyText() {
            const t = document.getElementById('outputText').innerText;
            navigator.clipboard.writeText(t);
            const toast = document.getElementById('toast');
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 2000);
        }
        function swapLangs() {
            const temp = state.src;
            state.src = state.tgt;
            state.tgt = temp;
            
            const sF = document.getElementById('srcFlag').innerText;
            const sN = document.getElementById('srcName').innerText;
            const tF = document.getElementById('tgtFlag').innerText;
            const tN = document.getElementById('tgtName').innerText;

            document.getElementById('srcFlag').innerText = tF;
            document.getElementById('srcName').innerText = tN;
            document.getElementById('tgtFlag').innerText = sF;
            document.getElementById('tgtName').innerText = sN;

            const input = document.getElementById('inputText').value;
            const output = document.getElementById('outputText').innerText;
            if (input && !output.includes("...")) {
                document.getElementById('inputText').value = output;
                autoTranslate();
            }
        }
    </script>
</body>
</html>
